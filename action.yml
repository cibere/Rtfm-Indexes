name: 'Run Parser'
description: ''
inputs:
  filename:
    required: true
  error_hook:
    required: true

runs:
  using: "composite"
  steps:
    - name: Install uv
      uses: astral-sh/setup-uv@v5

    - name: Run Parser
      continue-on-error: true
      id: parser
      shell: bash
      run: |
        uv run _parsers/${{ inputs.filename }}.py 1> output.txt 2>&1
    
    - name: Print Runner Outcome
      shell: bash
      run: |
        echo ${{ steps.parser.outcome }}
        echo ${{ fromJson(steps.parser) }}

    - name: Print Output.txt
      shell: bash
      run: |
        cat output.txt
  
    - name: Write output to file
      if: ${{ steps.parser.outcome == 'failure' }}
      uses: DamianReeves/write-file-action@master
      with:
        path: output.txt
        write-mode: overwrite
        contents: |
          ${{ steps.parser.output }}
    
    - name: Print Output.txt
      shell: bash
      run: |
        cat output.txt

    - name: Handle Error
      if: ${{ steps.parser.outcome == 'failure' }}
      uses: tsickert/discord-webhook@v6.0.0
      with:
        webhook-url: ${{ inputs.error_hook }}
        content: Parser for ${{ inputs.filename }} failed!
        filename: output.txt